---
- name: Copy dnstt-client
  copy:
    src: dnstt-client
    dest: /usr/local/bin/dnstt-client
    mode: 0755

- name: Copy public shared key to client node
  copy:
    src: "/tmp/{{ shared_pubkey }}"
    dest: "{{ keys_path }}/{{ item }}"
    mode: "0600"
  when: lb_enabled

- name: Copy per tunnel public keys to client node
  copy:
    src: "/tmp/{{ tun.name }}.pub"
    dest: "{{ keys_path }}/{{ tun.name }}.pub"
    mode: 0644
  loop: "{{ tuns }}"
  loop_control:
    loop_var: tun
  when: not lb_enabled

- name: Make systemd unit file for each tunnel
  template:
    src: smuggler@.service.j2
    dest: "/etc/systemd/system/smuggler@{{ tun.name }}.service"
    mode: 0644
    owner: root
    group: root
  loop: "{{ tuns }}"
  loop_control:
    loop_var: tun
  changed_when: true

- name: Reload systemd
  systemd:
    daemon_reload: true
  changed_when: true

- name: Enable and start tunnel services
  systemd:
    name: "smuggler@{{ tun.name }}"
    enabled: true
    state: restarted
  loop: "{{ tuns }}"
  loop_control:
    loop_var: tun
  changed_when: true
